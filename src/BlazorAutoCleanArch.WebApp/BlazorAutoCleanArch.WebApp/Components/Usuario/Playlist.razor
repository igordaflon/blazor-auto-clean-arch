@page "/usuario/{IdUsuario}/playlist/{IdPlaylist:int}"
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]
@inject NavigationManager NavigationManager

<div class="visualizar-playlist-page">
    <!-- Header da Playlist -->
    <div class="playlist-header bg-gradient p-5">
        <div class="container-fluid px-5">
            <div class="row align-items-end">
                <div class="col-auto">
                    <img src="@playlist.ImageUrl"
                         alt="@playlist.Nome"
                         class="playlist-cover shadow-lg" />
                </div>
                <div class="col">
                    <p class="text-white-50 mb-2 small text-uppercase fw-semibold">Playlist</p>
                    <h1 class="display-3 fw-bold text-white mb-3">@playlist.Nome</h1>
                    <p class="text-white mb-3">@playlist.Descricao</p>
                    <div class="d-flex align-items-center text-white-50 small">
                        <span class="fw-semibold text-white me-2">@playlist.Criador</span>
                        <span>• @playlist.Musicas.Count músicas</span>
                        <span class="ms-2">• @CalcularDuracaoTotal()</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Controles e Músicas -->
    <div class="playlist-content bg-dark">
        <div class="container-fluid px-5 py-4">
            <!-- Controles principais -->
            <div class="playlist-controls mb-4 d-flex align-items-center gap-3">
                <button class="btn-play-large btn-success rounded-circle shadow" @onclick="PlayTodas">
                    <i class="bi bi-play-fill"></i>
                </button>
                <button class="btn btn-outline-light rounded-circle" @onclick="ToggleFavorito">
                    <i class="bi @(playlist.EhFavorita ? "bi-heart-fill" : "bi-heart")"></i>
                </button>
                <button class="btn btn-outline-light rounded-circle" @onclick="Compartilhar">
                    <i class="bi bi-share"></i>
                </button>
                <div class="dropdown">
                    <button class="btn btn-outline-light rounded-circle dropdown-toggle"
                            type="button"
                            id="maisOpcoes"
                            data-bs-toggle="dropdown">
                        <i class="bi bi-three-dots"></i>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-dark">
                        <li><a class="dropdown-item" href="#" @onclick="EditarPlaylist"><i class="bi bi-pencil me-2"></i>Editar</a></li>
                        <li><a class="dropdown-item" href="#" @onclick="DeletarPlaylist"><i class="bi bi-trash me-2"></i>Excluir</a></li>
                    </ul>
                </div>
            </div>

            <!-- Lista de Músicas -->
            <div class="musicas-table">
                <!-- Cabeçalho -->
                <div class="musica-header d-none d-md-flex text-white-50 small border-bottom border-secondary pb-2 mb-2">
                    <div class="musica-col-numero">#</div>
                    <div class="musica-col-titulo flex-grow-1">TÍTULO</div>
                    <div class="musica-col-album d-none d-lg-block">ÁLBUM</div>
                    <div class="musica-col-data d-none d-xl-block">ADICIONADA EM</div>
                    <div class="musica-col-duracao text-end">
                        <i class="bi bi-clock"></i>
                    </div>
                </div>

                <!-- Músicas -->
                @foreach (var (musica, index) in playlist.Musicas.Select((m, i) => (m, i + 1)))
                {
                    <div class="musica-row bg-body-secondary rounded-2 p-3 mb-2 @(musicaTocando?.Id == musica.Id ? "playing" : "")"
                         @onclick="() => PlayMusica(musica)"
                         @onmouseenter="() => musicaHover = musica.Id"
                         @onmouseleave="() => musicaHover = null">
                        <div class="musica-col-numero">
                            @if (musicaTocando?.Id == musica.Id)
                            {
                                <div class="playing-indicator">
                                    <span></span>
                                    <span></span>
                                    <span></span>
                                </div>
                            }
                            else if (musicaHover == musica.Id)
                            {
                                <i class="bi bi-play-fill text-white"></i>
                            }
                            else
                            {
                                <span class="text-white-50">@index</span>
                            }
                        </div>
                        <div class="musica-col-titulo flex-grow-1">
                            <div class="d-flex align-items-center">
                                <img src="@musica.CapaUrl" alt="@musica.Nome" class="musica-thumb rounded me-3" />
                                <div>
                                    <h6 class="text-white mb-0">@musica.Nome</h6>
                                    <p class="text-white-50 small mb-0">@musica.Artista</p>
                                </div>
                            </div>
                        </div>
                        <div class="musica-col-album d-none d-lg-block">
                            <span class="text-white-50 small">@musica.Album</span>
                        </div>
                        <div class="musica-col-data d-none d-xl-block">
                            <span class="text-white-50 small">@musica.DataAdicionada.ToString("dd/MM/yyyy")</span>
                        </div>
                        <div class="musica-col-duracao text-end">
                            <div class="d-flex align-items-center justify-content-end gap-2">
                                @if (musicaHover == musica.Id)
                                {
                                    <button class="btn btn-sm btn-link text-white-50 p-0"
                                            @onclick:stopPropagation="true"
                                            @onclick="() => ToggleFavoritoMusica(musica)">
                                        <i class="bi @(musica.EhFavorita ? "bi-heart-fill" : "bi-heart")"></i>
                                    </button>
                                }
                                <span class="text-white-50 small">@musica.Duracao</span>
                                @if (musicaHover == musica.Id)
                                {
                                    <button class="btn btn-sm btn-link text-white-50 p-0"
                                            @onclick:stopPropagation="true"
                                            @onclick="() => RemoverMusica(musica)">
                                        <i class="bi bi-x-lg"></i>
                                    </button>
                                }
                            </div>
                        </div>
                    </div>
                }

                @if (playlist.Musicas.Count == 0)
                {
                    <div class="text-center py-5">
                        <i class="bi bi-music-note-list display-1 text-white-50"></i>
                        <p class="text-white-50 mt-3">Esta playlist está vazia</p>
                        <button class="btn btn-primary rounded-pill px-4" @onclick="AdicionarMusicas">
                            <i class="bi bi-plus-circle me-2"></i>Adicionar Músicas
                        </button>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

<style>
    article.px-4 {
        padding: 0 !important;
    }

    .visualizar-playlist-page {
        margin: 0;
        padding: 0;
        width: 100%;
    }

    .playlist-header {
        background: linear-gradient(135deg, #512bd4 0%, #8b5cf6 50%, #3b82f6 100%);
        min-height: 340px;
        display: flex;
        align-items: flex-end;
        width: 100%;
    }

    .playlist-cover {
        width: 232px;
        height: 232px;
        object-fit: cover;
        border-radius: 8px;
    }

    .playlist-content {
        min-height: calc(100vh - 340px);
        background: linear-gradient(180deg, rgba(81, 43, 212, 0.15) 0%, #0d1117 20%);
        width: 100%;
    }

    .btn-play-large {
        width: 56px;
        height: 56px;
        display: flex;
        align-items: center;
        justify-content: center;
        border: none;
        transition: transform 0.2s ease;
    }

        .btn-play-large i {
            font-size: 1.5rem;
            margin-left: 3px;
        }

        .btn-play-large:hover {
            transform: scale(1.06);
        }

    .btn-success {
        background: linear-gradient(135deg, #1db954 0%, #1ed760 100%);
    }

    .btn-outline-light {
        border-color: rgba(255, 255, 255, 0.3);
        color: rgba(255, 255, 255, 0.7);
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0;
    }

        .btn-outline-light:hover {
            background-color: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.5);
            color: white;
        }

    .musica-header {
        display: flex;
        padding: 0 1rem;
    }

    .musica-row {
        display: flex;
        align-items: center;
        cursor: pointer;
        transition: background-color 0.2s ease;
        background-color: transparent !important;
    }

        .musica-row:hover {
            background-color: rgba(255, 255, 255, 0.05) !important;
        }

        .musica-row.playing {
            background-color: rgba(81, 43, 212, 0.2) !important;
        }

    .musica-col-numero {
        width: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .musica-col-titulo {
        min-width: 0;
    }

    .musica-col-album {
        width: 25%;
    }

    .musica-col-data {
        width: 150px;
    }

    .musica-col-duracao {
        width: 100px;
    }

    .musica-thumb {
        width: 40px;
        height: 40px;
        object-fit: cover;
    }

    .playing-indicator {
        display: flex;
        gap: 3px;
        align-items: flex-end;
        height: 16px;
    }

        .playing-indicator span {
            width: 3px;
            background: #1db954;
            animation: playing 0.8s ease-in-out infinite;
        }

            .playing-indicator span:nth-child(1) {
                animation-delay: 0s;
            }

            .playing-indicator span:nth-child(2) {
                animation-delay: 0.2s;
            }

            .playing-indicator span:nth-child(3) {
                animation-delay: 0.4s;
            }

    @@keyframes playing {
        0%, 100% {
            height: 4px;
        }

        50% {
            height: 16px;
        }
    }

    .text-white-50 {
        color: rgba(255, 255, 255, 0.7);
    }

    .bg-body-secondary {
        background-color: transparent;
    }

    .dropdown-menu-dark {
        background-color: #282828;
        border: 1px solid #404040;
    }

        .dropdown-menu-dark .dropdown-item {
            color: rgba(255, 255, 255, 0.7);
        }

            .dropdown-menu-dark .dropdown-item:hover {
                background-color: rgba(255, 255, 255, 0.1);
                color: white;
            }

    .btn-primary {
        background: linear-gradient(135deg, #512bd4 0%, #8b5cf6 100%);
        border: none;
    }

        .btn-primary:hover {
            background: linear-gradient(135deg, #6d3aea 0%, #a78bfa 100%);
            transform: scale(1.02);
        }

    .btn-link {
        text-decoration: none;
    }

        .btn-link:hover {
            text-decoration: none;
        }
</style>

@code {
    [Parameter]
    public string IdUsuario { get; set; } = string.Empty;

    [Parameter]
    public int IdPlaylist { get; set; }

    private PlaylistDetalheModel playlist = new();
    private MusicaDetalheModel? musicaTocando;
    private string? musicaHover;

    protected override void OnInitialized()
    {
        CarregarPlaylist();
    }

    private void CarregarPlaylist()
    {
        // TODO: Implementar carregamento da playlist da API
        playlist = new PlaylistDetalheModel
        {
            Id = IdPlaylist,
            Nome = "Rock Clássico",
            Descricao = "Os maiores clássicos do rock de todos os tempos",
            Criador = "Igor Daflon",
            ImageUrl = "https://picsum.photos/232/232?random=1",
            EhFavorita = false,
            Musicas = new List<MusicaDetalheModel>
            {
                new() { Id = "1", Nome = "Bohemian Rhapsody", Artista = "Queen", Album = "A Night at the Opera", Duracao = "5:55", CapaUrl = "https://picsum.photos/40/40?random=1", DataAdicionada = DateTime.Now.AddDays(-10), EhFavorita = true },
                new() { Id = "2", Nome = "Stairway to Heaven", Artista = "Led Zeppelin", Album = "Led Zeppelin IV", Duracao = "8:02", CapaUrl = "https://picsum.photos/40/40?random=2", DataAdicionada = DateTime.Now.AddDays(-9), EhFavorita = false },
                new() { Id = "3", Nome = "Hotel California", Artista = "Eagles", Album = "Hotel California", Duracao = "6:30", CapaUrl = "https://picsum.photos/40/40?random=3", DataAdicionada = DateTime.Now.AddDays(-8), EhFavorita = true },
                new() { Id = "4", Nome = "Imagine", Artista = "John Lennon", Album = "Imagine", Duracao = "3:03", CapaUrl = "https://picsum.photos/40/40?random=4", DataAdicionada = DateTime.Now.AddDays(-7), EhFavorita = false },
                new() { Id = "5", Nome = "Smells Like Teen Spirit", Artista = "Nirvana", Album = "Nevermind", Duracao = "5:01", CapaUrl = "https://picsum.photos/40/40?random=5", DataAdicionada = DateTime.Now.AddDays(-6), EhFavorita = false },
                new() { Id = "6", Nome = "Sweet Child O' Mine", Artista = "Guns N' Roses", Album = "Appetite for Destruction", Duracao = "5:56", CapaUrl = "https://picsum.photos/40/40?random=6", DataAdicionada = DateTime.Now.AddDays(-5), EhFavorita = true },
                new() { Id = "7", Nome = "Yesterday", Artista = "The Beatles", Album = "Help!", Duracao = "2:05", CapaUrl = "https://picsum.photos/40/40?random=7", DataAdicionada = DateTime.Now.AddDays(-4), EhFavorita = false },
                new() { Id = "8", Nome = "Nothing Else Matters", Artista = "Metallica", Album = "Metallica", Duracao = "6:28", CapaUrl = "https://picsum.photos/40/40?random=8", DataAdicionada = DateTime.Now.AddDays(-3), EhFavorita = false },
            }
        };
    }

    private string CalcularDuracaoTotal()
    {
        if (playlist.Musicas.Count == 0)
            return "0 min";

        // Simplificado - em produção, calcular duração real
        var totalMinutos = playlist.Musicas.Count * 5;
        var horas = totalMinutos / 60;
        var minutos = totalMinutos % 60;

        if (horas > 0)
            return $"{horas} h {minutos} min";
        return $"{minutos} min";
    }

    private void PlayTodas()
    {
        if (playlist.Musicas.Count > 0)
        {
            musicaTocando = playlist.Musicas.First();
            Console.WriteLine($"Tocando todas as músicas da playlist: {playlist.Nome}");
        }
    }

    private void PlayMusica(MusicaDetalheModel musica)
    {
        musicaTocando = musica;
        Console.WriteLine($"Tocando: {musica.Nome} - {musica.Artista}");
    }

    private void ToggleFavorito()
    {
        playlist.EhFavorita = !playlist.EhFavorita;
        Console.WriteLine($"Playlist {(playlist.EhFavorita ? "adicionada aos" : "removida dos")} favoritos");
    }

    private void ToggleFavoritoMusica(MusicaDetalheModel musica)
    {
        musica.EhFavorita = !musica.EhFavorita;
        Console.WriteLine($"Música {musica.Nome} {(musica.EhFavorita ? "adicionada aos" : "removida dos")} favoritos");
    }

    private void Compartilhar()
    {
        Console.WriteLine("Compartilhar playlist");
        // TODO: Implementar compartilhamento
    }

    private void EditarPlaylist()
    {
        NavigationManager.NavigateTo($"/usuario/{IdUsuario}/playlist/{IdPlaylist}/editar");
    }

    private void DeletarPlaylist()
    {
        Console.WriteLine("Deletar playlist");
        // TODO: Implementar confirmação e exclusão
    }

    private void RemoverMusica(MusicaDetalheModel musica)
    {
        playlist.Musicas.Remove(musica);
        Console.WriteLine($"Música {musica.Nome} removida da playlist");
    }

    private void AdicionarMusicas()
    {
        NavigationManager.NavigateTo($"/usuario/{IdUsuario}/playlist/{IdPlaylist}/adicionar");
    }

    private class PlaylistDetalheModel
    {
        public int Id { get; set; }
        public string Nome { get; set; } = string.Empty;
        public string Descricao { get; set; } = string.Empty;
        public string Criador { get; set; } = string.Empty;
        public string ImageUrl { get; set; } = string.Empty;
        public bool EhFavorita { get; set; }
        public List<MusicaDetalheModel> Musicas { get; set; } = new();
    }

    private class MusicaDetalheModel
    {
        public string Id { get; set; } = string.Empty;
        public string Nome { get; set; } = string.Empty;
        public string Artista { get; set; } = string.Empty;
        public string Album { get; set; } = string.Empty;
        public string Duracao { get; set; } = string.Empty;
        public string CapaUrl { get; set; } = string.Empty;
        public DateTime DataAdicionada { get; set; }
        public bool EhFavorita { get; set; }
    }
}