@page "/usuario/{Id}/playlist/nova"
@using System.ComponentModel.DataAnnotations
@using BlazorAutoCleanArch.Aplicacao.DTOs.Requests
@using BlazorAutoCleanArch.Aplicacao.Servicos.Interfaces
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]
@rendermode InteractiveServer
@inject IPlaylistsAppServico PlaylistsAppServico
@inject NavigationManager NavigationManager
@inject ILogger<NovaPlaylist> Logger

<style>
    article.px-4 {
        padding: 0 !important;
    }

    .criar-playlist-page {
        margin: 0;
        padding: 0;
        width: 100%;
    }

    .criar-playlist-header {
        background: linear-gradient(135deg, #512bd4 0%, #8b5cf6 50%, #3b82f6 100%);
        min-height: 200px;
        width: 100%;
    }

    .criar-playlist-content {
        min-height: calc(100vh - 200px);
        background: linear-gradient(180deg, rgba(81, 43, 212, 0.15) 0%, #0d1117 20%);
        width: 100%;
    }

    .bg-body-secondary {
        background-color: #1a1d29 !important;
    }

    .cover-placeholder {
        width: 50%;
        aspect-ratio: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, #512bd4 0%, #8b5cf6 100%);
    }

        .cover-placeholder i {
            font-size: 4rem;
        }

    .form-control {
        background-color: #0d1117 !important;
        border: 1px solid transparent !important;
    }

        .form-control:focus {
            background-color: #0d1117 !important;
            border-color: #512bd4 !important;
            box-shadow: 0 0 0 0.2rem rgba(81, 43, 212, 0.25);
            color: white !important;
        }

    .validation-message {
        color: #dc3545;
        font-size: 0.875rem;
        margin-top: 0.25rem;
    }

    .nav-tabs {
        border-bottom: 1px solid #252a3a;
    }

        .nav-tabs .nav-link {
            color: rgba(255, 255, 255, 0.7);
            border: none;
            background: transparent;
            padding: 0.75rem 1.5rem;
            border-bottom: 2px solid transparent;
        }

            .nav-tabs .nav-link:hover {
                color: white;
                border-bottom-color: #512bd4;
            }

            .nav-tabs .nav-link.active {
                color: white;
                background: transparent;
                border-bottom-color: #512bd4;
            }

    .musicas-lista {
        max-height: 600px;
        overflow-y: auto;
        padding-right: 10px;
    }

        .musicas-lista::-webkit-scrollbar {
            width: 8px;
        }

        .musicas-lista::-webkit-scrollbar-track {
            background: #0d1117;
            border-radius: 4px;
        }

        .musicas-lista::-webkit-scrollbar-thumb {
            background: #512bd4;
            border-radius: 4px;
        }

    .musica-item {
        transition: background-color 0.2s ease, transform 0.2s ease;
    }

        .musica-item:hover {
            background-color: #252a3a !important;
            transform: translateX(4px);
        }

    .musica-capa {
        width: 56px;
        height: 56px;
        object-fit: cover;
    }

    .btn-primary {
        background: linear-gradient(135deg, #512bd4 0%, #8b5cf6 100%);
        border: none;
    }

        .btn-primary:hover:not(:disabled) {
            background: linear-gradient(135deg, #6d3aea 0%, #a78bfa 100%);
            transform: scale(1.02);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

    .btn-outline-primary {
        border-color: #512bd4;
        color: #8b5cf6;
    }

        .btn-outline-primary:hover {
            background: linear-gradient(135deg, #512bd4 0%, #8b5cf6 100%);
            border-color: #512bd4;
            color: white;
        }

    .btn-outline-secondary {
        border-color: #6c757d;
        color: rgba(255, 255, 255, 0.7);
    }

        .btn-outline-secondary:hover {
            background-color: #6c757d;
            color: white;
        }

    .btn-outline-danger {
        border-color: #dc3545;
        color: #dc3545;
    }

        .btn-outline-danger:hover {
            background-color: #dc3545;
            color: white;
        }

    .text-white-50 {
        color: rgba(255, 255, 255, 0.7);
    }

    .input-group-text {
        background-color: #0d1117 !important;
    }

    .bg-gradient-primary {
        background: linear-gradient(135deg, #512bd4 0%, #8b5cf6 100%);
    }

    .btn-link {
        text-decoration: none;
    }

        .btn-link:hover {
            text-decoration: underline;
        }

    .alert-danger {
        background-color: rgba(220, 53, 69, 0.1);
        border: 1px solid #dc3545;
        color: #ff6b6b;
    }
</style>

<div class="criar-playlist-page">
    <!-- Header -->
    <div class="criar-playlist-header bg-gradient p-5">
        <div class="container-fluid px-5">
            <div class="row align-items-center">
                <div class="col">
                    <a href="/usuario/perfil" class="btn btn-link text-white-50 p-0 mb-3">
                        <i class="bi bi-arrow-left me-2"></i>Voltar ao Perfil
                    </a>
                    <h1 class="display-4 fw-bold text-white mb-2">Criar Nova Playlist</h1>
                    <p class="text-white-50 mb-0">Crie sua playlist personalizada</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Conteúdo principal -->
    <div class="criar-playlist-content bg-dark">
        <div class="container-fluid px-5 py-5">
            @if (!string.IsNullOrEmpty(mensagemErro))
            {
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                    @mensagemErro
                    <button type="button" class="btn-close" @onclick="() => mensagemErro = string.Empty"></button>
                </div>
            }

            <EditForm Model="@model" OnValidSubmit="@SalvarPlaylist">
                <DataAnnotationsValidator />

                <div class="row">
                    <!-- Coluna da esquerda - Informações da Playlist -->
                    <div class="col-lg-4 mb-4">
                        <div class="playlist-info-card bg-body-secondary rounded-3 p-4">
                            <h3 class="h5 text-white mb-4">Informações da Playlist</h3>

                            <!-- Preview da capa -->
                            <div class="playlist-cover-preview mb-4 text-center">
                                <div class="cover-placeholder bg-gradient-primary rounded-2 mx-auto">
                                    <i class="bi bi-music-note-list text-white"></i>
                                </div>
                            </div>

                            <!-- Nome da Playlist -->
                            <div class="mb-4">
                                <label for="playlistNome" class="form-label text-white-50 small">Nome da Playlist</label>
                                <InputText id="playlistNome"
                                           class="form-control form-control-lg bg-dark text-white border-0"
                                           @bind-Value="model.Nome"
                                           placeholder="Ex: Minhas Favoritas 2024"
                                           maxlength="100" />
                                <small class="text-white-50">@(model.Nome?.Length ?? 0) / 100</small>
                                <ValidationMessage For="@(() => model.Nome)" class="validation-message" />
                            </div>

                            <!-- Descrição -->
                            <div class="mb-4">
                                <label for="playlistDescricao" class="form-label text-white-50 small">Descrição (opcional)</label>
                                <InputTextArea id="playlistDescricao"
                                               class="form-control bg-dark text-white border-0"
                                               @bind-Value="model.Descricao"
                                               rows="3"
                                               placeholder="Descreva sua playlist..."
                                               maxlength="300" />
                                <small class="text-white-50">@(model.Descricao?.Length ?? 0) / 300</small>
                            </div>

                            <!-- Botões de ação -->
                            <div class="d-grid gap-2">
                                <button type="submit"
                                        class="btn btn-primary btn-lg rounded-pill">
                                    @if (salvando)
                                    {
                                        <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                                        <span>Salvando...</span>
                                    }
                                    else
                                    {
                                        <i class="bi bi-check-circle me-2"></i>
                                        <span>Criar Playlist</span>
                                    }
                                </button>
                                <button type="button" class="btn btn-outline-secondary rounded-pill" @onclick="Cancelar" disabled="@salvando">
                                    Cancelar
                                </button>
                            </div>

                            <!-- Estatísticas -->
                            <div class="mt-4 pt-4 border-top border-secondary">
                                <div class="d-flex justify-content-between text-white-50 small mb-2">
                                    <span>Músicas adicionadas:</span>
                                    <span class="text-white fw-semibold">@musicasSelecionadas.Count</span>
                                </div>
                                <div class="d-flex justify-content-between text-white-50 small">
                                    <span>Duração total:</span>
                                    <span class="text-white fw-semibold">@CalcularDuracaoTotal()</span>
                                </div>
                                @if (musicasSelecionadas.Count == 0)
                                {
                                    <div class="mt-2">
                                        <small class="text-danger">
                                            <i class="bi bi-exclamation-circle me-1"></i>
                                            Adicione ao menos uma música
                                        </small>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>

                    <!-- Coluna da direita - Adicionar Músicas -->
                    <div class="col-lg-8">
                        <div class="musicas-section">
                            <!-- Barra de busca -->
                            <div class="search-bar mb-4">
                                <div class="input-group input-group-lg">
                                    <span class="input-group-text bg-dark border-0">
                                        <i class="bi bi-search text-white-50"></i>
                                    </span>
                                    <input type="text"
                                           class="form-control bg-dark text-white border-0"
                                           placeholder="Buscar músicas, artistas ou álbuns..."
                                           @bind="termoBusca"
                                           @bind:event="oninput" />
                                </div>
                            </div>

                            <!-- Abas -->
                            <ul class="nav nav-tabs border-0 mb-4">
                                <li class="nav-item">
                                    <button type="button"
                                            class="nav-link @(abaAtiva == "buscar" ? "active" : "")"
                                            @onclick='() => abaAtiva = "buscar"'>
                                        <i class="bi bi-search me-2"></i>Buscar Músicas
                                    </button>
                                </li>
                                <li class="nav-item">
                                    <button type="button"
                                            class="nav-link @(abaAtiva == "selecionadas" ? "active" : "")"
                                            @onclick='() => abaAtiva = "selecionadas"'>
                                        <i class="bi bi-music-note-list me-2"></i>
                                        Selecionadas (@musicasSelecionadas.Count)
                                    </button>
                                </li>
                            </ul>

                            <!-- Conteúdo das abas -->
                            @if (abaAtiva == "buscar")
                            {
                                <div class="musicas-lista">
                                    @if (string.IsNullOrWhiteSpace(termoBusca))
                                    {
                                        <div class="text-center py-5">
                                            <i class="bi bi-music-note-beamed display-1 text-white-50"></i>
                                            <p class="text-white-50 mt-3">Digite algo para buscar músicas</p>
                                        </div>
                                    }
                                    else
                                    {
                                        @foreach (var musica in MusicasFiltradas())
                                        {
                                            <div class="musica-item bg-body-secondary rounded-3 p-3 mb-2 d-flex align-items-center">
                                                <img src="@musica.CapaUrl" alt="@musica.Nome" class="musica-capa rounded me-3" />
                                                <div class="flex-grow-1">
                                                    <h6 class="text-white mb-1">@musica.Nome</h6>
                                                    <p class="text-white-50 small mb-0">@musica.Artista • @musica.Album</p>
                                                </div>
                                                <span class="text-white-50 me-3">@musica.Duracao</span>
                                                @if (musicasSelecionadas.Any(m => m.Id == musica.Id))
                                                {
                                                    <button type="button"
                                                            class="btn btn-outline-danger rounded-pill btn-sm"
                                                            @onclick="() => RemoverMusica(musica)">
                                                        <i class="bi bi-check-circle-fill me-1"></i>Adicionada
                                                    </button>
                                                }
                                                else
                                                {
                                                    <button type="button"
                                                            class="btn btn-outline-primary rounded-pill btn-sm"
                                                            @onclick="() => AdicionarMusica(musica)">
                                                        <i class="bi bi-plus-circle me-1"></i>Adicionar
                                                    </button>
                                                }
                                            </div>
                                        }
                                    }
                                </div>
                            }
                            else
                            {
                                <div class="musicas-lista">
                                    @if (musicasSelecionadas.Count == 0)
                                    {
                                        <div class="text-center py-5">
                                            <i class="bi bi-music-note-list display-1 text-white-50"></i>
                                            <p class="text-white-50 mt-3">Nenhuma música adicionada ainda</p>
                                            <button type="button" class="btn btn-primary rounded-pill" @onclick='() => abaAtiva = "buscar"'>
                                                Buscar Músicas
                                            </button>
                                        </div>
                                    }
                                    else
                                    {
                                        @foreach (var musica in musicasSelecionadas)
                                        {
                                            <div class="musica-item bg-body-secondary rounded-3 p-3 mb-2 d-flex align-items-center">
                                                <span class="text-white-50 me-3">@(musicasSelecionadas.IndexOf(musica) + 1)</span>
                                                <img src="@musica.CapaUrl" alt="@musica.Nome" class="musica-capa rounded me-3" />
                                                <div class="flex-grow-1">
                                                    <h6 class="text-white mb-1">@musica.Nome</h6>
                                                    <p class="text-white-50 small mb-0">@musica.Artista • @musica.Album</p>
                                                </div>
                                                <span class="text-white-50 me-3">@musica.Duracao</span>
                                                <button type="button"
                                                        class="btn btn-outline-danger rounded-pill btn-sm"
                                                        @onclick="() => RemoverMusica(musica)">
                                                    <i class="bi bi-x-circle me-1"></i>Remover
                                                </button>
                                            </div>
                                        }
                                    }
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </EditForm>
        </div>
    </div>
</div>

@code {
    [Parameter]
    public string Id { get; set; } = string.Empty;

    private PlaylistInserirRequest model = new();
    private string termoBusca = "";
    private string abaAtiva = "buscar";
    private string mensagemErro = string.Empty;
    private bool salvando = false;
    private List<MusicaModel> musicasDisponiveis = new();
    private List<MusicaModel> musicasSelecionadas = new();

    protected override void OnInitialized()
    {
        CarregarMusicasDisponiveis();
    }

    private void CarregarMusicasDisponiveis()
    {
        // TODO: Implementar carregamento de músicas da API
        musicasDisponiveis = new List<MusicaModel>
        {
            new() { Id = 1, Nome = "Bohemian Rhapsody", Artista = "Queen", Album = "A Night at the Opera", Duracao = "5:55", CapaUrl = "https://picsum.photos/56/56?random=1" },
            new() { Id = 2, Nome = "Stairway to Heaven", Artista = "Led Zeppelin", Album = "Led Zeppelin IV", Duracao = "8:02", CapaUrl = "https://picsum.photos/56/56?random=2" },
            new() { Id = 3, Nome = "Hotel California", Artista = "Eagles", Album = "Hotel California", Duracao = "6:30", CapaUrl = "https://picsum.photos/56/56?random=3" },
            new() { Id = 4, Nome = "Imagine", Artista = "John Lennon", Album = "Imagine", Duracao = "3:03", CapaUrl = "https://picsum.photos/56/56?random=4" },
            new() { Id = 5, Nome = "Smells Like Teen Spirit", Artista = "Nirvana", Album = "Nevermind", Duracao = "5:01", CapaUrl = "https://picsum.photos/56/56?random=5" },
            new() { Id = 6, Nome = "Sweet Child O' Mine", Artista = "Guns N' Roses", Album = "Appetite for Destruction", Duracao = "5:56", CapaUrl = "https://picsum.photos/56/56?random=6" },
            new() { Id = 7, Nome = "Yesterday", Artista = "The Beatles", Album = "Help!", Duracao = "2:05", CapaUrl = "https://picsum.photos/56/56?random=7" },
            new() { Id = 8, Nome = "Nothing Else Matters", Artista = "Metallica", Album = "Metallica", Duracao = "6:28", CapaUrl = "https://picsum.photos/56/56?random=8" },
        };
    }

    private List<MusicaModel> MusicasFiltradas()
    {
        if (string.IsNullOrWhiteSpace(termoBusca))
            return new List<MusicaModel>();

        var termo = termoBusca.ToLower();
        return musicasDisponiveis
            .Where(m => m.Nome.ToLower().Contains(termo) ||
                       m.Artista.ToLower().Contains(termo) ||
                       m.Album.ToLower().Contains(termo))
            .ToList();
    }

    private void AdicionarMusica(MusicaModel musica)
    {
        if (!musicasSelecionadas.Any(m => m.Id == musica.Id))
        {
            musicasSelecionadas.Add(musica);
        }
    }

    private void RemoverMusica(MusicaModel musica)
    {
        musicasSelecionadas.RemoveAll(m => m.Id == musica.Id);
    }

    private string CalcularDuracaoTotal()
    {
        if (musicasSelecionadas.Count == 0)
            return "0:00";

        // Simplificado - em produção, calcular duração real
        var totalMinutos = musicasSelecionadas.Count * 4;
        return $"{totalMinutos}:00";
    }

    private async Task SalvarPlaylist()
    {
        if (musicasSelecionadas.Count == 0)
        {
            mensagemErro = "Adicione ao menos uma música à playlist.";
            return;
        }

        try
        {
            salvando = true;
            mensagemErro = string.Empty;

            model.MusicasId = musicasSelecionadas.Select(m => m.Id).ToList();

            await PlaylistsAppServico.InserirAsync(model, Id);

            Logger.LogInformation("Playlist '{Nome}' criada com sucesso para o usuário {UsuarioId}", model.Nome, Id);

            NavigationManager.NavigateTo("/usuario/perfil");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Erro ao salvar playlist: {Nome}", model.Nome);
            mensagemErro = "Erro ao criar playlist. Por favor, tente novamente.";
        }
        finally
        {
            salvando = false;
        }
    }

    private void Cancelar()
    {
        NavigationManager.NavigateTo("/usuario/perfil");
    }

    private class MusicaModel
    {
        public int Id { get; set; }
        public string Nome { get; set; } = string.Empty;
        public string Artista { get; set; } = string.Empty;
        public string Album { get; set; } = string.Empty;
        public string Duracao { get; set; } = string.Empty;
        public string CapaUrl { get; set; } = string.Empty;
    }
}